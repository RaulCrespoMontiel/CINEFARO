{% extends "base.html" %}
{% load static %}

{% block title %}{{ obra.titulo }} - Cine Faro{% endblock title %}

{% block content %}
<div class="detail-container" style="max-width: 900px; margin: 40px auto; padding: 20px; background: #222; border-radius: 8px;">
    
    <h1 style="color: #ffcc00;">{{ obra.titulo }}</h1>
    
    <p style="color: #ccc; font-size: 1.1em;">
        Director: {{ obra.nombre_autor }} | 
        
        <!-- üåü CORRECCI√ìN AQU√ç: Acceso directo al nombre del objeto Categoria üåü 
        Categor√≠a: **{{ obra.categoria.nombre|default:"Sin Categor√≠a" }}** | -->
        
        Categor√≠a: 
        {% for cat in obra.categoria.all %}
            {{ cat.nombre }}{% if not forloop.last %}, {% endif %}
        {% empty %}
            Sin Categor√≠a
        {% endfor %}
        |

        Calificaci√≥n: ‚òÖ {{ obra.rating_promedio }}
    </p>

    <div class="video-player" style="width: 100%; height: 500px; background: black; margin-bottom: 20px;">
        <p style="color: #fff; text-align: center; line-height: 500px;">[REPRODUCTOR DE VIDEO: {{ obra.url_video }}]</p>
    </div>

    <h3>Sinopsis</h3>
    <p style="line-height: 1.6;">{{ obra.descripcion }}</p>
    
    <hr style="border-color: #444;">

    <div class="propina-box" style="background: #333; padding: 15px; border-radius: 5px; margin-top: 20px;">
        <h4>Brindar ayuda econ√≥mica al equipo independiente</h4>
        
        {% if user.is_authenticated %}
            <!-- Asumo que la URL 'dar_propina' est√° definida en app_creadores/urls.py -->
            <form method="post" action="{% url 'app_creadores:dar_propina' obra.id %}">
                {% csrf_token %}
                <p style="margin-top: 0;">Monto deseado:</p>
                <div style="display: flex; gap: 10px;">
                    {{ propina_form.monto }}
                    <button type="submit" style="background-color: #ffcc00; color: #000; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">Confirmar Pago (Simulaci√≥n)</button>
                </div>
            </form>
        {% else %}
            <p style="color: #E50914;">Debes iniciar sesi√≥n para dar una propina.</p>
        {% endif %}
    </div>
    
    <hr style="border-color: #444; margin: 30px 0;">
    
    <div class="comentarios-seccion">
        <h2 style="color: #ffcc00;">Comentarios ({{ obra.comentarios.count }})</h2>
        
        {% if user.is_authenticated %}
            <!-- Llamada correcta a la vista central de comentarios -->
            <form method="post" action="{% url 'agregar_comentario' 'obra' obra.id %}">
                {% csrf_token %}
                {{ form_comentario.as_p }} 
                <button type="submit" style="background-color: #E50914; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer;">Publicar Comentario</button>
            </form>
        {% else %}
            <p style="color: #ccc;">Debes <a href="{% url 'registro' %}" style="color: #ffcc00;">iniciar sesi√≥n</a> para comentar.</p>
        {% endif %}

        <div style="margin-top: 20px;">
            {% for comentario in obra.comentarios.all|dictsortreversed:'fecha_creacion' %}
            <div style="border-bottom: 1px dotted #444; padding: 10px 0;">
                <p style="margin: 0;">
                    <strong style="color: #fff;">{{ comentario.usuario.username }}</strong> 
                    <small style="color: #999;">({{ comentario.fecha_creacion|date:"d M Y h:i A" }})</small>
                </p>
                <p style="color: #ccc; margin-top: 5px;">{{ comentario.contenido }}</p>
            </div>
            {% empty %}
            <p style="color: #777;">S√© el primero en comentar.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock content %}